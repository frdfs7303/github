<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹è€…è£è€€å°é©¬ç³•å£ä»¤åˆ†äº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            min-height: 100vh;
        }
        
        h1 {
            font-size: 20px;
            color: #e74c3c;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .ç¦åˆ©æç¤º {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .ç¦åˆ©æç¤º p {
            font-size: 14px;
            color: #856404;
        }
        
        .ç¦åˆ©æç¤º p span {
            font-weight: 600;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 16px;
            background-color: #e74c3c;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .input-box {
            margin-bottom: 15px;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        input[type="text"]::placeholder {
            color: #999;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .btn-primary:hover {
            background-color: #c0392b;
        }
        
        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .warning-box p {
            font-size: 14px;
            color: #721c24;
            font-weight: 500;
        }
        
        .data-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
        }
        
        .data-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            flex: 0 0 calc(50% - 5px);
            max-width: calc(50% - 5px);
            min-width: 180px;
        }
        
        @media (max-width: 400px) {
            .data-item {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
        
        .data-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .price {
            font-size: 18px;
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            padding: 6px;
            font-size: 11px;
            margin-bottom: 6px;
            word-break: break-all;
        }
        
        .time {
            font-size: 10px;
            color: #999;
        }
        
        .copy-btn {
            width: 100%;
            padding: 5px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            background-color: #3498db;
            color: #fff;
            cursor: pointer;
            margin-top: 6px;
            transition: background-color 0.3s ease;
        }
        
        .copy-btn:hover {
            background-color: #2980b9;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .section-title {
                font-size: 15px;
            }
            
            input[type="text"],
            input[type="number"] {
                padding: 10px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px;
                font-size: 15px;
            }
            
            .data-grid {
                gap: 8px;
            }
            
            .data-item {
                padding: 12px;
            }
            
            .price {
                font-size: 16px;
            }
            
            .code {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç‹è€…è£è€€å°é©¬ç³•å£ä»¤åˆ†äº«</h1>
        
        <div class="ç¦åˆ©æç¤º">
            <p><a href="https://b.qianwen.com/dragon/vBqu5CZ39/KH6YQromhwxrJq1/GIoaAAhAf8?qk_r_web_str=OPT%3AHIDDEN%401%7COPT%3ATOAST%400&click_src=hx0llc8cn1at&click_subsrc=p4jjfer59waj&qshare_entry=clipboard&entry=newyear_drinks&inviteCode=29d91214b2d5b1046497e68fc8f99ed7&actType=ShanGou&qwcontainer=qk&s_f=cp" target="_blank" style="color: #d63031; text-decoration: underline; font-size: 16px; font-weight: bold;">ğŸ”¥é™æ—¶ç¦åˆ©ï¼ç‚¹æˆ‘å…è´¹é¢†ä¸€å¼ 25å…ƒå¥¶èŒ¶å…å•å¡ğŸ”¥</a></p>
            <p><a href="https://qun.qq.com/universal-share/share?ac=1&authKey=18IOGlTLPI85FmyEl4ZnoBysJnF6ElJwjHgH%2B1BFVZC%2FvZFbhXSblhuCuF39LTdH&busi_data=eyJncm91cENvZGUiOiI3ODI0NTA3NTciLCJ0b2tlbiI6IjNKK2pIMytOcnpPc05IdXlHR1BWTjVTaGkxZmZ2aHFEVnk4N1BOSlIrWFRhWkZtc3pEWjRnSnllRmVNMythQjkiLCJ1aW4iOiIzOTkxNzAxNjUzIn0%3D&data=dCtPH4m01JZz55DTHAIt55r2MpKDwApVHOlqSfwqyEn4h96XjSx2sJlu2Si4fOKJE9JmCuhmkUSs8ZvvrZH30A&svctype=4&tempid=h5_group_info" target="_blank" style="color: #27ae60; text-decoration: underline; font-size: 18px; font-weight: bold;">ğŸ‰æ¬¢è¿åŠ å…¥äº¤æµç¾¤ğŸ‰</a></p>
        </div>
        
        <div class="section">
            <div class="section-title">åˆ†äº«ä½ çš„å°é©¬ç³•å£ä»¤</div>
            <div class="input-box">
                <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„å°é©¬ç³•å£ä»¤ï¼Œç³»ç»Ÿè‡ªåŠ¨æå–ä»·æ ¼">
            </div>
            <button class="btn btn-primary">åˆ†äº«å£ä»¤</button>
            
            <div class="warning-box">
                <p>æ³¨æ„æ ¸å®å°é©¬ç³•æ•°é‡!</p>
            </div>
            
            <div class="refresh-control" style="margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap;">
                <input type="checkbox" id="auto-refresh" checked style="margin-right: 8px;">
                <label for="auto-refresh" style="font-size: 14px; color: #666;">å®æ—¶åˆ·æ–°</label>
                <span id="last-update" style="margin-left: 10px; font-size: 12px; color: #999;">ä¸Šæ¬¡æ›´æ–°: åˆšåˆš</span>
            </div>
            
            <div class="threshold-control" style="margin-bottom: 15px; display: flex; align-items: center;">
                <label for="threshold" style="font-size: 14px; color: #666; margin-right: 8px;">å±è”½ä½äº:</label>
                <input type="number" id="threshold" value="300" min="0" max="999" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;">
                <span style="margin-left: 8px; font-size: 14px; color: #666;">çš„æ•°å€¼</span>
            </div>
            
            <div class="data-grid" id="dataGrid">
                <!-- åˆå§‹åŠ è½½çŠ¶æ€ -->
                <div style="text-align: center; padding: 40px; color: #999; width: 100%;">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // å¯¼å…¥APIè®¿é—®å‡½æ•°
        import { fetchApiData, getThreshold, filterData } from './api.js';
        let refreshIntervalId = null;
        
        // æ¸²æŸ“æ•°æ®
        function renderData(data) {
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­
                if (typeof window === 'undefined' || typeof document === 'undefined') {
                    console.error('Not in browser environment');
                    return;
                }
                
                // æ£€æŸ¥dataGridå…ƒç´ æ˜¯å¦å­˜åœ¨
                const dataGrid = document.getElementById('dataGrid');
                if (!dataGrid) {
                    console.error('dataGrid element not found');
                    return;
                }
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                if (!Array.isArray(data)) {
                    console.error('Invalid data format, expected array');
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    dataGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999; width: 100%;">æ•°æ®æ ¼å¼é”™è¯¯</div>';
                    return;
                }
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMæ“ä½œ
                const fragment = document.createDocumentFragment();
                
                // ç›´æ¥æ·»åŠ æ¯ä¸ªæ•°æ®é¡¹åˆ°ç½‘æ ¼ä¸­ï¼Œå®ç°ä¸¤åˆ—å¸ƒå±€
                if (data.length > 0) {
                    data.forEach((item) => {
                        // æ£€æŸ¥æ•°æ®é¡¹æ˜¯å¦æœ‰æ•ˆ
                        if (!item || typeof item !== 'object') {
                            return;
                        }
                        
                        const dataItem = document.createElement('div');
                        dataItem.className = 'data-item';
                        
                        // æ ¼å¼åŒ–æ—¶é—´
                        let formattedTime = 'æ—¶é—´: æœªçŸ¥';
                        if (item.time && typeof item.time === 'string') {
                            const timeParts = item.time.split(' ');
                            if (timeParts.length === 2) {
                                formattedTime = `æ—¶é—´: ${timeParts[0]} ${timeParts[1]}`;
                            }
                        }
                        
                        // ç¡®ä¿æ•°æ®é¡¹å±æ€§å­˜åœ¨
                        const num = item.num || 0;
                        const name = item.name || '';
                        const code = item.code || '';
                        const fullCode = name + code;
                        
                        dataItem.innerHTML = `
                            <div class="price">${num}</div>
                            <div class="code">${fullCode}</div>
                            <div class="time">${formattedTime}</div>
                            <button class="copy-btn" data-code="${fullCode}">å¤åˆ¶</button>
                        `;
                        
                        fragment.appendChild(dataItem);
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    const noDataMessage = document.createElement('div');
                    noDataMessage.style.textAlign = 'center';
                    noDataMessage.style.padding = '40px';
                    noDataMessage.style.color = '#999';
                    noDataMessage.style.width = '100%';
                    noDataMessage.textContent = 'æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•°æ®';
                    fragment.appendChild(noDataMessage);
                }
                
                // ä¸€æ¬¡æ€§æ›´æ–°DOM
                dataGrid.innerHTML = '';
                dataGrid.appendChild(fragment);
                
                // æ·»åŠ å¤åˆ¶åŠŸèƒ½
                addCopyEventListeners();
            } catch (error) {
                console.error('Error rendering data:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const dataGrid = document.getElementById('dataGrid');
                if (dataGrid) {
                    dataGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999; width: 100%;">æ¸²æŸ“é”™è¯¯</div>';
                }
            }
        }
        
        // æ·»åŠ å¤åˆ¶äº‹ä»¶ç›‘å¬å™¨
        function addCopyEventListeners() {
            try {
                const copyBtns = document.querySelectorAll('.copy-btn');
                copyBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const code = btn.getAttribute('data-code');
                        copyToClipboard(code);
                        
                        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                        const originalText = btn.textContent;
                        btn.textContent = 'å·²å¤åˆ¶!';
                        btn.style.backgroundColor = '#27ae60';
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.backgroundColor = '#3498db';
                        }, 1000);
                    });
                });
            } catch (error) {
                console.error('Error adding copy event listeners:', error);
            }
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    document.execCommand('copy') ? resolve() : reject();
                    textArea.remove();
                });
            }
        }
        
        // è·å–æ•°æ®
        async function fetchData() {
            try {
                // è°ƒç”¨APIè®¿é—®å‡½æ•°è·å–æ•°æ®
                const data = await fetchApiData();
                
                // è·å–ç”¨æˆ·è®¾ç½®çš„å±è”½é˜ˆå€¼
                const threshold = getThreshold();
                
                // è¿‡æ»¤æ•°æ®ï¼Œåªæ˜¾ç¤ºå¤§äºç­‰äºé˜ˆå€¼çš„æ•°æ®
                const filteredData = filterData(data, threshold);
                
                // ç¡®ä¿åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°UI
                if (typeof window !== 'undefined' && window.requestAnimationFrame) {
                    window.requestAnimationFrame(() => {
                        renderData(filteredData);
                        updateLastUpdateTime();
                    });
                } else {
                    renderData(filteredData);
                    updateLastUpdateTime();
                }
            } catch (error) {
                // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œç›´æ¥ä½¿ç”¨å¤‡ç”¨æ¨¡æ‹Ÿæ•°æ®
                const now = new Date();
                const currentHour = now.getHours().toString().padStart(2, '0');
                const currentMinute = now.getMinutes().toString().padStart(2, '0');
                const currentSecond = now.getSeconds().toString().padStart(2, '0');
                const currentTime = `${currentHour}:${currentMinute}:${currentSecond}`;
                
                const backupData = [
                    { name: "åœ£è¯ç‹‚æ¬¢", code: "E6J7ME", num: 765, time: `09 ${currentTime}` },
                    { name: "æµ·æ´‹ä¹‹å¿ƒ", code: "KZ2KRA", num: 981, time: `09 ${currentTime}` },
                    { name: "åœ£è¯ç‹‚æ¬¢", code: "I58277", num: 847, time: `09 ${currentTime}` },
                    { name: "èŠ‚å¥çƒ­æµª", code: "2ZLTR7", num: 999, time: `09 ${currentTime}` },
                    { name: "åˆ›ä¸–ç¥ç¥", code: "UI2L1Y", num: 873, time: `09 ${currentTime}` },
                    { name: "æ˜Ÿå¤œç‹å­", code: "MJ879M", num: 858, time: `09 ${currentTime}` }
                ];
                
                // è·å–ç”¨æˆ·è®¾ç½®çš„å±è”½é˜ˆå€¼
                const threshold = getThreshold();
                
                // è¿‡æ»¤å¤‡ç”¨æ•°æ®ï¼Œåªæ˜¾ç¤ºå¤§äºç­‰äºé˜ˆå€¼çš„æ•°æ®
                const filteredBackupData = filterData(backupData, threshold);
                renderData(filteredBackupData);
                updateLastUpdateTime();
            }
        }
        
        // æ›´æ–°ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const lastUpdateElement = document.getElementById('last-update');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `ä¸Šæ¬¡æ›´æ–°: ${hours}:${minutes}:${seconds}`;
            }
        }
        
        // åˆå§‹åŒ–
        function init() {
            try {
                console.log('Initializing...');
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­
                if (typeof window === 'undefined') {
                    console.error('Not in browser environment');
                    return;
                }
                
                // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const dataGrid = document.getElementById('dataGrid');
                if (!dataGrid) {
                    console.error('dataGrid element not found');
                    return;
                }
                
                // é¦–æ¬¡è·å–æ•°æ®
                console.log('Fetching initial data...');
                fetchData();
                
                // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
                console.log('Starting auto refresh...');
                startAutoRefresh();
                
                // æ·»åŠ å¤é€‰æ¡†ç›‘å¬
                const autoRefreshCheckbox = document.getElementById('auto-refresh');
                if (autoRefreshCheckbox) {
                    console.log('Adding auto refresh checkbox listener...');
                    autoRefreshCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            console.log('Auto refresh enabled');
                            startAutoRefresh();
                        } else {
                            console.log('Auto refresh disabled');
                            stopAutoRefresh();
                        }
                    });
                }
                
                console.log('Initialized successfully');
            } catch (error) {
                console.error('Error initializing:', error);
                // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºä¸€äº›æ•°æ®
                try {
                    const now = new Date();
                    const currentHour = now.getHours().toString().padStart(2, '0');
                    const currentMinute = now.getMinutes().toString().padStart(2, '0');
                    const currentSecond = now.getSeconds().toString().padStart(2, '0');
                    const currentTime = `${currentHour}:${currentMinute}:${currentSecond}`;
                    
                    const backupData = [
                        { name: "åœ£è¯ç‹‚æ¬¢", code: "E6J7ME", num: 765, time: `09 ${currentTime}` },
                        { name: "æµ·æ´‹ä¹‹å¿ƒ", code: "KZ2KRA", num: 981, time: `09 ${currentTime}` },
                        { name: "åœ£è¯ç‹‚æ¬¢", code: "I58277", num: 847, time: `09 ${currentTime}` },
                        { name: "èŠ‚å¥çƒ­æµª", code: "2ZLTR7", num: 999, time: `09 ${currentTime}` },
                        { name: "åˆ›ä¸–ç¥ç¥", code: "UI2L1Y", num: 873, time: `09 ${currentTime}` },
                        { name: "æ˜Ÿå¤œç‹å­", code: "MJ879M", num: 858, time: `09 ${currentTime}` }
                    ];
                    
                    const threshold = getThreshold();
                    const filteredBackupData = filterData(backupData, threshold);
                    renderData(filteredBackupData);
                    updateLastUpdateTime();
                } catch (innerError) {
                    console.error('Error displaying backup data:', innerError);
                }
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (!refreshIntervalId) {
                console.log('Starting auto refresh every 5 seconds');
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡è·å–æ•°æ®
                fetchData();
                // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ‰§è¡Œä¸€æ¬¡
                refreshIntervalId = setInterval(fetchData, 5000);
                console.log('Auto refresh started with interval ID:', refreshIntervalId);
            }
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshIntervalId) {
                console.log('Stopping auto refresh');
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>